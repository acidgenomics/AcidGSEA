---
params:
  title: "Gene Set Enrichment Analysis"
  
  # Use DESeqAnalysis object as input.
  # Basic: Load from file on disk, either RDS or RDA.
  # Advanced: Loop across multiple objects using `rmarkdown::render()`.
  object: "rds/YYYY-MM-DD/DESeqAnalysis.rds"
  name: "object_name"
  
  # MSigDb GMT files downloaded from the Broad Institute.
  # Email registration is required for these files.
  gmt_dir: "~/msigdb/msigdb_v6.2_GMTs"
  
  # Either values are acceptable:
  # 1. Shrunken LFC ("log2FoldChange").
  # 2. Wald test statistic ("stat").
  gsea_value: "log2FoldChange"
  
  # GSEA alpha cutoff.
  # Doesn't have to match the alpha used for DESeqResults.
  alpha: 0.05
  
  min_size: 15
  max_size: 500
  n_perm: 1000
  
  data_dir: !r file.path("rds", Sys.Date())
  output_dir: !r file.path("results", Sys.Date(), "gsea")

title: "`r params$title`"
author: "`r getOption('author')`"
date: "`r Sys.Date()`"
bibliography: bibliography.bib
---

```{r setup, message=FALSE}
# Last modified 2019-03-11
library(pfgsea)
library(tidyverse)
prepareTemplate()
source("_setup.R")
```

```{r header, child="_header.Rmd"}
```

```{r basename}
basename <- basenameSansExt(params$object_file)
print(basename)
```

Import the `DESeqAnalysis` S4 class object. This single object contains everything we need to perform GSEA.

```{r object}
if (is.character(params$object)) {
    if (fileExt(object) == "rds") {
        object <- readRDS(file = params$object)
        name <- basenameSansExt(params$object)
    } else if (fileExt(object) == "rda") {
        name <- load(params$object)
        object <- get(name, inherits = FALSE)
    }
} else {
    object <- params$object
    name <- params$name
}
stopifnot(
    is(object, "DESeqAnalysis"),
    is.character(name)
)
invisible(validObject(object))
print(object)
```

All genes can be used in Gene Set Enrichment Analysis (GSEA). GSEA aggregates the per gene statistics across genes within a gene set, therefore making it possible to detect situations where all genes in a predefined set change in a small but coordinated way. Since it is likely that many relevant phenotypic differences are manifested by small but consistent changes in a set of genes. GSEA uses a ranked list of genes (here ranked by the test statistic), without applying a per-gene *P* value significance cutoff. This allows the analysis to use more information to identify enriched biological processes. The [GSEA introduction](http://www.ncbi.nlm.nih.gov/pmc/articles/PMC1239896) goes into more detail about some of the advantages of this approach.

# Ranked gene list

Prepare a ranked `numeric vector` [gene list](https://github.com/GuangchuangYu/DOSE/wiki/how-to-prepare-your-own-geneList) for GSEA.

It requires three features:

1. numeric: test statistic (*preferred*) or log2 fold change. For [DESeq2][], the test statistic is generated using the Wald test by default (see `DESeq2::DESeq()`, `DESeq2::nbinomWaldTest()`).
2. named: every number has a name, the corresponding gene ID.
3. sorted: number should be sorted in decreasing order.

Note that [MSigDb][] requires that the identifiers map either to HGNC names (gene symbols) or Entrez IDs. We prefer to map using the gene symbols, but these are not 1:1 for all Ensembl gene IDs (e.g. ENSG00000000003 = TSPAN6). In the event that there are Ensembl gene IDs per HGNC symbol, we're taking the average of the values here.

```{r ranked_list}
ranked_list <- RankedList(object, value = params$gsea_value)
lapply(ranked_list, head)
lapply(ranked_list, summary)
assignAndSaveData(
    name = paste(basename, "ranked_list", sep = "_"),
    object = ranked_list,
    dir = params$data_dir
)
```

# MSigDb GMT files

Here we are using pathways from the MSigDB database. GSEA requires a gene list containing names that match the gene names in the MSigDb pathways list (i.e. gene symbols instead of Ensembl gene IDs).

Before proceeding, first download the [MSigDb 6.2 release](http://software.broadinstitute.org/gsea/msigdb/download_file.jsp?filePath=/resources/msigdb/6.2/msigdb_v6.2_files_to_download_locally.zip) and extract the ZIP archive, which will contain GMT files. Note that e-mail registration is required to access resources at the Broad Institute.

```{r gmt_files}
gmt_files <- list.files(
    path = params$gmt_dir,
    pattern = "all.v6.2.symbols.gmt$",
    full.names = TRUE
)
names(gmt_files) <- str_extract(
    string = basename(gmt_files),
    pattern = "^[[:alnum:]]+"
)
print(basename(gmt_files))
```

# Run GSEA

This section is a modified version of Stephen Turner's excellent [DESeq results to pathways in 60 Seconds with the fgsea package](https://stephenturner.github.io/deseq-to-fgsea/) vignette. The [fgsea vignette](https://bioconductor.org/packages/release/bioc/vignettes/fgsea/inst/doc/fgsea-tutorial.html) also has additional useful information.

Each row corresponds to a tested pathway. The columns are the following:

- `pathway`: name of the pathway.
- `pval`: an enrichment *P* value.
- `padj`: BH-adjusted *P* value.
- `ES`: enrichment score, same as in Broad GSEA implementation.
- `NES`: enrichment score normalized to mean enrichment of random samples of the same size.
- `nMoreExtreme`: a number of times a random gene set had a more extreme enrichment score value.
- `size`: size of the pathway after removing genes not present in 'names(stats)'.
- `leadingEdge`: vector with indexes of leading edge genes that drive the enrichment.

Here we are arranging the tables by normalized enrichment score (NES), positive to negative.

```{r gsea}
gsea <- pfgsea(
    rankedList = ranked_list,
    gmtFiles = gmt_files,
    nPerm = params$n_perm,
    minSize = params$min_size,
    maxSize = params$max_size
)
assignAndSaveData(
    name = paste(basename, "gsea", sep = "_"),
    object = gsea,
    dir = params$data_dir
)
```

```{r export}
export(gsea, dir = params$output_dir)
```

# Hallmark

First, let's use the *Homo sapiens* Hallmark collection from MSigDb. Hallmark gene sets summarize and represent specific well-defined biological states or processes and display coherent expression. These gene sets were generated by a computational methodology based on identifying overlaps between gene sets in other MSigDb collections and retaining genes that display coordinate expression.

The `fgsea::gmtPathways()` function will take a GMT file from MSigDb and turn it into a list. Each element in the list is a character vector of genes in the pathway.

## Top tables {.tabset}

```{r h_top_tables, results="asis"}
topTables(
    object = gsea,
    geneSet = "h",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

## Plot GSEA table {.tabset}

```{r h_plot_gsea_table, results="asis"}
plotGSEATable(
    object = gsea,
    geneSet = "h",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

## Plot enrichment {.tabset}

```{r h_plot_enrichment, results="asis"}
plotEnrichment(
    object = gsea,
    geneSet = "h",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

# C1

## Top tables {.tabset}

```{r c1_top_tables, results="asis"}
topTables(
    object = gsea,
    geneSet = "c1",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

## Plot GSEA table {.tabset}

```{r c1_plot_gsea_table, results="asis"}
plotGSEATable(
    object = gsea,
    geneSet = "c1",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

## Plot enrichment {.tabset}

```{r c1_plot_enrichment, results="asis"}
plotEnrichment(
    object = gsea,
    geneSet = "c1",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

# C2

## Top tables {.tabset}

```{r c2_top_tables, results="asis"}
topTables(
    object = gsea,
    geneSet = "c2",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

## Plot GSEA table {.tabset}

```{r c2_plot_gsea_table, results="asis"}
plotGSEATable(
    object = gsea,
    geneSet = "c2",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

## Plot enrichment {.tabset}

```{r c2_plot_enrichment, results="asis"}
plotEnrichment(
    object = gsea,
    geneSet = "c2",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

# C3

## Top tables {.tabset}

```{r c3_top_tables, results="asis"}
topTables(
    object = gsea,
    geneSet = "c3",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

## Plot GSEA table {.tabset}

```{r c3_plot_gsea_table, results="asis"}
plotGSEATable(
    object = gsea,
    geneSet = "c3",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

## Plot enrichment {.tabset}

```{r c3_plot_enrichment, results="asis"}
plotEnrichment(
    object = gsea,
    geneSet = "c3",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

# C4

## Top tables {.tabset}

```{r c4_top_tables, results="asis"}
topTables(
    object = gsea,
    geneSet = "c4",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

## Plot GSEA table {.tabset}

```{r c4_plot_gsea_table, results="asis"}
plotGSEATable(
    object = gsea,
    geneSet = "c4",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

## Plot enrichment {.tabset}

```{r c4_plot_enrichment, results="asis"}
plotEnrichment(
    object = gsea,
    geneSet = "c4",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

# C5

## Top tables {.tabset}

```{r c5_top_tables, results="asis"}
topTables(
    object = gsea,
    geneSet = "c5",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

## Plot GSEA table {.tabset}

```{r c5_plot_gsea_table, results="asis"}
plotGSEATable(
    object = gsea,
    geneSet = "c5",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

## Plot enrichment {.tabset}

```{r c5_plot_enrichment, results="asis"}
plotEnrichment(
    object = gsea,
    geneSet = "c5",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

# C6

## Top tables {.tabset}

```{r c6_top_tables, results="asis"}
topTables(
    object = gsea,
    geneSet = "c6",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

## Plot GSEA table {.tabset}

```{r c6_plot_gsea_table, results="asis"}
plotGSEATable(
    object = gsea,
    geneSet = "c6",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

## Plot enrichment {.tabset}

```{r c6_plot_enrichment, results="asis"}
plotEnrichment(
    object = gsea,
    geneSet = "c6",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

# C7

## Top tables {.tabset}

```{r c7_top_tables, results="asis"}
topTables(
    object = gsea,
    geneSet = "c7",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

## Plot GSEA table {.tabset}

```{r c7_plot_gsea_table, results="asis"}
plotGSEATable(
    object = gsea,
    geneSet = "c7",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

## Plot enrichment {.tabset}

```{r c7_plot_enrichment, results="asis"}
plotEnrichment(
    object = gsea,
    geneSet = "c7",
    alpha = params$alpha,
    n = params$n_pathways,
    headerLevel = 3
)
```

```{r footer, child="_footer.Rmd"}
```
